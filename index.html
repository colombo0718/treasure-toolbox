<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <title>ÊãºÈü≥ Poker Âç°Áâå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Noto Sans CJK SC", "PingFang SC", sans-serif;
      background: radial-gradient(circle at top, #e3f2fd, #bbdefb);
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 1.4rem;
      color: #1a237e;
    }

    #deck {
      display: flex;
      flex-direction: column;
      gap: 32px;
      align-items: center;
    }

    .suit-group {
      width: 100%;
      max-width: 1400px;
    }

    .suit-title {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .suit-title span.icon {
      font-size: 1.3rem;
    }

    .suit-grid {
      display: grid;
      grid-template-columns: repeat(8, minmax(0, 1fr));
      gap: 10px;
    }

    canvas.cardCanvas {
      width: 100%;
      height: auto;
      display: block;
      background: transparent;
    }

    #downloadBtn {
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 1.2rem;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: block;
    }
  </style>
</head>
<body>
  <h1>Êº¢Ë™ûÊãºÈü≥ Poker Âç°Áâå</h1>

  <div id="deck"></div>
  <button id="downloadBtn">‰∏ãËºâÊâÄÊúâ PNG ÁÇ∫ ZIP</button>

  <!-- ‰Ω†ÁöÑÁâåÁµÑË®≠ÂÆö -->
  <script src="pinyinDeck_ds.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    const CARD_W = 630;
    const CARD_H = 880;
    const BORDER_RADIUS = 12; // ÂúìËßíÂ∞è‰∏ÄÈªû
    const BORDER_WIDTH = 8;   // ÈÇäÁ∑öÁ¥∞‰∏ÄÈªû

    // ÂõõÁµÑÁâåÁöÑÈ°èËâ≤
    const SUIT_COLORS = {
      L: "#42a5f5", // Listening: Ëóç
      S: "#ef5350", // Speaking: Á¥Ö
      R: "#66bb6a", // Reading: Á∂†
      W: "#fbc02d"  // Writing: ÈªÉ
    };

    // ËßíËêΩÁî®ÁöÑÂÖ©ÂÄã iconÔºàÁî® emoji Â≠óÂÖÉÔºåÂØ¶ÈöõÊúÉËΩâÊàê OpenMoji PNGÔºâ
    const SUIT_ICON_EMOJIS = {
      L: ["üëÇ", "üíß"], // ear + droplet
      S: ["üëÑ", "üî•"], // mouth + fire
      R: ["üëÄ", "ü™µ"], // eyes + seedling
      W: ["‚úçÔ∏è", "üå¨Ô∏è"] // writing hand + wind
    };
    
    
    
    // LeafLune ÂìÅÁâå logo
    const LEAFLUNE_LOGO_SRC = "XuanXuexi_emoji.png"; // Â¶ÇÊûúÊúâÊîæÂà∞Â≠êË≥áÊñôÂ§æÂ∞±ÊîπË∑ØÂæë
    let LEAFLUNE_LOGO = null;
    
    function loadLeafluneLogo() {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          LEAFLUNE_LOGO = img;
          resolve();
        };
        img.onerror = () => {
          console.warn("LeafLune logo ËºâÂÖ•Â§±Êïó");
          resolve();
        };
        img.src = LEAFLUNE_LOGO_SRC;
      });
    }

    const OPENMOJI_BASE =
      "https://cdn.jsdelivr.net/gh/hfg-gmuend/openmoji/color/618x618";

    const EMOJI_IMG_CACHE = {};

    // Â∞á emoji ËΩâÊàê OpenMoji Ê™îÂêçÔºàÁî®Á¨¨‰∏ÄÂÄã code pointÔºåÂ∞±ËÉΩÈÅøÈñã FE0F Á≠âËÆäÈ´îÔºâ
    function emojiToOpenMojiUrl(emoji) {
      const cpHex = emoji.codePointAt(0).toString(16).toUpperCase();
      return `${OPENMOJI_BASE}/${cpHex}.png`;
    }

    function loadEmojiImage(emoji) {
      return new Promise((resolve) => {
        if (EMOJI_IMG_CACHE[emoji]) {
          resolve(EMOJI_IMG_CACHE[emoji]);
          return;
        }
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          EMOJI_IMG_CACHE[emoji] = img;
          resolve(img);
        };
        img.onerror = () => {
          console.warn("ËºâÂÖ• OpenMoji Â§±ÊïóÔºö", emoji, emojiToOpenMojiUrl(emoji));
          resolve(null);
        };
        img.src = emojiToOpenMojiUrl(emoji);
      });
    }

    async function prepareAllEmojiImages(cards) {
      const set = new Set();

      cards.forEach((c) => set.add(c.emoji));
      Object.values(SUIT_ICON_EMOJIS).forEach((arr) =>
        arr.forEach((e) => set.add(e))
      );

      const promises = [];
      set.forEach((e) => promises.push(loadEmojiImage(e)));
      await Promise.all(promises);
    }

    function drawRoundedRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }

    // Áï´ËßíËêΩÔºöÂÖ©ÂÄã suit Âúñ + 16 ÈÄ≤‰ΩçÁ∑®Ëôü
    function drawCornerCluster(ctx, originX, originY, suitKey, hex, rotate180) {
      const icons = SUIT_ICON_EMOJIS[suitKey] || [];
      const iconSize = 80;
      const gap = 8;

      ctx.save();
      ctx.font = "52px system-ui, sans-serif";
      ctx.textBaseline = "middle";

      // ÂÖàÁÆóÊï¥È´îÂØ¨Â∫¶ÔºåÊñπ‰æøËôïÁêÜÂè≥‰∏ãËßíÊóãËΩâÂ∞çÈΩä
      let iconsWidth = icons.length * iconSize + (icons.length - 1) * gap;
      let textWidth = ctx.measureText(hex).width + 6;
      const totalWidth = iconsWidth + textWidth;
      const totalHeight = iconSize;

      if (rotate180) {
        ctx.translate(originX, originY);
        ctx.rotate(Math.PI);
        // ctx.translate(-totalWidth, -totalHeight);
      } else {
        ctx.translate(originX, originY);
      }

      let x = 0;
      const y = 0;

      icons.forEach((emoji) => {
        const img = EMOJI_IMG_CACHE[emoji];
        if (img) {
          ctx.drawImage(img, x, y, iconSize, iconSize);
        }
        x += iconSize + gap;
      });

      ctx.fillStyle = SUIT_COLORS[suitKey] || "#444";
      ctx.fillText(hex, x + 3, iconSize / 2 + 1);

      ctx.restore();
    }

    function drawCard(ctx, card) {
      ctx.clearRect(0, 0, CARD_W, CARD_H);

      // Âç°Áâá‰∏ªÈ´îÔºàÁôΩÂ∫ï + ÂΩ©Ëâ≤Â§ñÊ°ÜÔºâ
      const margin = BORDER_WIDTH * 1.2;

      drawRoundedRect(
        ctx,
        margin,
        margin,
        CARD_W - margin * 2,
        CARD_H - margin * 2,
        BORDER_RADIUS
      );

      ctx.fillStyle = "#ffffff";
      ctx.fill();

      ctx.lineWidth = BORDER_WIDTH;
      ctx.strokeStyle = SUIT_COLORS[card.suit] || "#2196f3";
      ctx.stroke();

      // Â∑¶‰∏äËßíÂíåÂè≥‰∏ãËßíÔºösuit icon + Á∑®Ëôü
      drawCornerCluster(ctx, margin + 10, margin + 10, card.suit, card.hex, false);
      drawCornerCluster(
        ctx,
        CARD_W - margin - 10,
        CARD_H - margin - 10,
        card.suit,
        card.hex,
        true
      );

      // ‰∏≠Â§ÆÂ§ßÂØ´ mainÔºàb, d, sh, ang...Ôºâ
      let fontSize;
      if (card.main.length === 1) fontSize = 220;
      else if (card.main.length === 2) fontSize = 190;
      else fontSize = 150;

      ctx.fillStyle = "#222";
      ctx.textAlign = "center";
      ctx.textBaseline = "alphabetic";
      ctx.font = `700 ${fontSize}px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans CJK SC", sans-serif`;
      ctx.fillText(card.main, CARD_W / 2, CARD_H * 0.4);

      // ‰∏ãÊñπÔºöemoji + Êº¢Â≠ó + ÊãºÈü≥
      const emojiImg = EMOJI_IMG_CACHE[card.emoji];
      const emojiSize = 200;
      const centerY = CARD_H * 0.64;

      if (emojiImg) {
        const emojiX = CARD_W / 2 - emojiSize// - 28;
        const emojiY = centerY - emojiSize / 2;
        ctx.drawImage(emojiImg, emojiX, emojiY, emojiSize, emojiSize);
      }

      const textX = CARD_W / 2 + emojiSize/4;

      ctx.textAlign = "left";
      // Êº¢Â≠ó
      ctx.fillStyle = "#222";
      ctx.font =
        '100px "Noto Sans CJK SC", "PingFang SC", system-ui, sans-serif';
      ctx.textBaseline = "alphabetic";
      ctx.fillText(card.hanzi, textX, centerY - 12);

      // ÊãºÈü≥
      ctx.fillStyle = "#555";
      ctx.font = '60px system-ui, "Noto Sans", sans-serif';
      ctx.textBaseline = "top";
      ctx.fillText(card.pinyin, textX + 4, centerY + 10);
      
      // 1) Âè≥‰∏ãËßíÂ∞è logoÔºàÂçäÈÄèÊòéÔºå‰∏çÊê∂Áï´Èù¢Ôºâ
      if (LEAFLUNE_LOGO) {
        // const logoSize = 90; // ÂèØ‰ª•ÂÜçË™øÂ∞èÔºå‰æãÂ¶Ç 70
        // const logoX = CARD_W - margin - logoSize - 24;
        // const logoY = margin + 8;
        
        
        const logoSize = 90; // ‰æù‰Ω†ÂéüÊú¨Ë®≠ÂÆö
const logoX = margin + 24;                           // Èù†Â∑¶
const logoY = CARD_H - margin - logoSize - 8;       // Èù†‰∏ã
// drawLeafLuneLogo(ctx, logoX, logoY, logoSize);
    
        ctx.save();
        ctx.globalAlpha = 0.35; // ÂçäÈÄèÊòé‰∏ÄÈªûÔºåÈÅøÂÖçÊê∂‰∏ªË¶ñË¶∫
        ctx.drawImage(LEAFLUNE_LOGO, logoX, logoY, logoSize, logoSize);
        ctx.restore();
      }
      
      
      

      // // 2) Â∑¶‰∏ãËßí LeafLuneÔºåÊï¥ÂÄãÊñáÂ≠óÊóãËΩâ 180¬∞
      // ctx.save();
      
      // // ÊääÂéüÈªûÁßªÂà∞„ÄåÂ∑¶‰∏ãËßíÂæÄÂÖßÁ∏Æ„ÄçÁöÑ‰ΩçÁΩÆÔºåÊï∏Â≠óÂèØ‰ª•ÂæÆË™ø
      // const pivotX = margin + 100;            // ÂæÄÂè≥Á∏Æ‰∏ÄÈªû
      // const pivotY = CARD_H - margin - 40;   // ÂæÄ‰∏äÁ∏Æ‰∏ÄÈªû
      // ctx.translate(pivotX, pivotY);
      
      
      
      
      // // ÊóãËΩâ 180 Â∫¶ÔºàœÄ ÂºßÂ∫¶Ôºâ
      // ctx.rotate(Math.PI);
      
      // // ‰ª•ÁõÆÂâçÈÄôÂÄãÈªûÁÇ∫‰∏≠ÂøÉÁï´Â≠ó
      // ctx.textAlign = "center";
      // ctx.textBaseline = "middle";
      // ctx.font =
      //   '28px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
      // ctx.fillStyle = "rgba(0, 0, 0, 0.55)";
      // ctx.fillText("LeafLune", 0, 0);
      
      // ctx.restore();
      
      
      
      // Âè≥‰∏äËßí LeafLune Â≠óÊ®£ÔºàÊ≠£ÂêëÔºâ
ctx.save();
ctx.textAlign = "right";
ctx.textBaseline = "top";
ctx.font =
  '32px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
ctx.fillStyle = "rgba(0, 0, 0, 0.55)";

// ÂØ¶Èöõ‰ΩçÁΩÆÂèØ‰ª•ÂæÆË™øÔºåÈÄôË£°ÂÖàÊäìÂú®Âè≥‰∏äËßíÂæÄÂÖßÁ∏Æ‰∏ÄÈªû
const brandX = CARD_W - margin - 24;
const brandY = margin + 24;

ctx.fillText("XuanXuexi", brandX, brandY);
ctx.restore();

      
    }

    async function main() {
      const deck = window.PINYIN_DECK;
      if (!deck) {
        console.error("Êâæ‰∏çÂà∞ window.PINYIN_DECKÔºåË´ãÁ¢∫Ë™ç pinyinDeck__ds.js Â∑≤ËºâÂÖ•„ÄÇ");
        return;
      }

      const suitsInfo = deck.suits;
      const cards = deck.cards;

      // ÂÖàÊääÊâÄÊúâÊúÉÁî®Âà∞ÁöÑ OpenMoji ÂúñÁâá + LeafLune logo ËºâÂ•Ω
      await Promise.all([
        prepareAllEmojiImages(cards),
        loadLeafluneLogo()
      ]);

      const deckEl = document.getElementById("deck");
      const suitOrder = ["L", "S", "R", "W"];

      const allCanvases = [];

      suitOrder.forEach((suitKey) => {
        const group = document.createElement("section");
        group.className = "suit-group";

        const title = document.createElement("div");
        title.className = "suit-title";
        title.style.color = SUIT_COLORS[suitKey] || "#000";

        const iconSpan = document.createElement("span");
        iconSpan.className = "icon";
        iconSpan.textContent = SUIT_ICON_EMOJIS[suitKey].join(" ");

        const nameSpan = document.createElement("span");
        const suitInfo = suitsInfo[suitKey];
        nameSpan.textContent = `${suitKey} ÁµÑ - ${suitInfo.name}`;

        title.appendChild(iconSpan);
        title.appendChild(nameSpan);
        group.appendChild(title);

        const grid = document.createElement("div");
        grid.className = "suit-grid";

        const suitCards = cards.filter((c) => c.suit === suitKey);
        suitCards.forEach((card) => {
          const canvas = document.createElement("canvas");
          canvas.width = CARD_W;
          canvas.height = CARD_H;
          canvas.className = "cardCanvas";
          const ctx = canvas.getContext("2d");
          drawCard(ctx, card);
          grid.appendChild(canvas);
          allCanvases.push({canvas, suit: card.suit, hex: card.hex});
        });

        group.appendChild(grid);
        deckEl.appendChild(group);
      });

      // Ê∑ªÂä†‰∏ãËºâÊåâÈàïÈÇèËºØ
      const downloadBtn = document.getElementById("downloadBtn");
      downloadBtn.addEventListener("click", () => downloadZip(allCanvases));
    }

    async function downloadZip(allCanvases) {
      const zip = new JSZip();
      for (const {canvas, suit, hex} of allCanvases) {
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const filename = `${suit}${hex}.png`;
        zip.file(filename, blob);
      }
      const content = await zip.generateAsync({type: "blob"});
      const url = URL.createObjectURL(content);
      const a = document.createElement("a");
      a.href = url;
      a.download = "pinyin_poker_cards.zip";
      a.click();
      URL.revokeObjectURL(url);
    }

    main();
  </script>
</body>
</html>